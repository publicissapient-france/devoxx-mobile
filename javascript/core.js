define(["log","utils","collection","entry","ui","db","synchronize"],function(e,t,n,r,i,s,o){function p(e,t,n,r,i,s,o){var u=l.getParams(t[1]);f.getPageContextValue(r.id,"id")!==u.id?(f.setPageContextValue(r.id,"initialized",!0),f.setPageContextValue(r.id,"id",u.id),s(u.id)):o&&o(e,t,n,r,i)}function d(e,t,n,r,i,s,o){var u=l.getParams(t[1]);f.getPageContextValue(r.id,"initialized")?o&&o(e,t,n,r,i):(f.setPageContextValue(r.id,"initialized",!0),s(u))}function v(e,t,n,r,i,s){var o=l.getParams(t[1]);s(o)}var u=e.getLogger("core");u.info("Loading core.js");var a="15",f={},l,c={events:[{id:"15",name:"Devoxx France 2015",days:[{id:"1",name:"Mercredi 8 Avril",date:"2015-04-08"},{id:"2",name:"Jeudi 9 Avril",date:"2015-04-09"},{id:"3",name:"Vendredi 10 Avril",date:"2015-04-10"}]}]};f.getEvent=function(e){return _(c.events).find(function(t){return t.id==e})},f.getDay=function(e,t){return _(e.days).find(function(e){return e.id==t})};var h={};return f.createPageContext=function(e){h[e]={initialized:!1}},f.initializePageContextIfNecessary=function(e){h[e]||f.createPageContext(e)},f.getPageContextValue=function(e,t){return f.initializePageContextIfNecessary(e),h[e][t]},f.getPageContexts=function(){return h},f.setPageContextValue=function(e,t,n){f.initializePageContextIfNecessary(e),h[e][t]=n},f.clearPageContexts=function(){_(f.getPageContexts()).each(function(e){e.id&&(e.id=undefined),e.initialized&&(e.initialized=!1)})},f.addUrlsForEvent=function(e){o.addUrl(e+"/schedule",t.getFullUrl("/"+e+"/schedule?callback=?")),o.addUrl(e+"/presentations",t.getFullUrl("/"+e+"/presentations?callback=?")),o.addUrl(e+"/rooms",t.getFullUrl("/"+e+"/rooms?callback=?")),o.addUrl(e+"/tracks",t.getFullUrl("/"+e+"/tracks?callback=?")),o.addUrl(e+"/speakers",t.getFullUrl("/"+e+"/speakers?callback=?"))},f.setupRouter=function(){u.info("Instanciating jqmr router"),l=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))":{handler:"onBeforeDayPageShow",events:"bs"},"#event(?:[?](.*))":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomsPageShow",events:"bs"},"#room(?:[?](.*))":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#track(?:[?](.*))":{handler:"onBeforeTrackPageShow",events:"bs"},"#synchronize":{handler:"onBeforeSynchronizePageShow",events:"bs"}},{onBeforeSchedulePageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.refreshSchedule,f.renderCollectionView)},onBeforeDayPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshDay,f.renderCollectionView)},onBeforeEventPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshEvent)},onBeforeRoomsPageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.refreshRooms)},onBeforeRoomPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshRoom,f.renderCollectionView)},onBeforeTracksPageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.refreshTracks)},onBeforeTrackPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshTrack,f.renderCollectionView)},onBeforePresentationsPageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.refreshPresentations,f.renderCollectionView)},onBeforePresentationPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshPresentation,f.renderEntryView)},onBeforeSpeakersPageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.refreshSpeakers)},onBeforeSpeakerPageShow:function(e,t,n,r,i){p(e,t,n,r,i,f.refreshSpeaker)},onBeforeSynchronizePageShow:function(e,t,n,r,i){d(e,t,n,r,i,f.onSynchronizeBeforePageShow)}}),u.info("Instanciated jqmr router")},f.refreshDataList=function(e){u.info("Loading "+e.title+" View"),n.views[e.view]=new n.EntryListView({dataType:e.dataType,fetchUrl:e.url,el:e.el,collectionTemplate:e.template,parse:function(t){return e.cacheKey&&!t.statusCode&&s.save(e.cacheKey,t),e.parse&&(t=e.parse(t)),t},view:e.view,postRender:e.postRender}),n.views[e.view].collection.length!==0&&n.views[e.view].collection.reset([]),u.info("Fetch "+e.title+" Data from url: '"+n.views[e.view].collection.url+"'");var t={onFetch:function(){$.mobile.showPageLoadingMsg(),i.showFlashMessage(e)},success:function(t,n){e.success&&e.success(t,n),f.onFetchSuccess(t,n,e)},error:function(t,n,r){f.onFetchError(t,n,r,e)},fetchUrl:e.url};s.getOrFetch(e.cacheKey,function(t){e.parse&&(t=e.parse(t)),n.views[e.view].collection.reset(t),i.hideFlashMessage(e)},function(){t.onFetch&&t.onFetch(),n.views[e.view].el.empty(),n.views[e.view].collection.fetch(t)})},f.refreshDataEntry=function(e){u.info("Loading "+e.title+" View"),r.views[e.view]=new r.EntryView({dataType:e.dataType,fetchUrl:e.url,el:e.el,entryTemplate:e.template,parse:function(t){return e.cacheKey&&!t.statusCode&&s.save(e.cacheKey,t),e.parse&&(t=e.parse(t)),t},postRender:e.postRender,view:e.view}),r.views[e.view].entry&&r.views[e.view].entry.clear(),u.info("Fetch "+e.title+" Data from url: '"+r.views[e.view].entry.url+"'");var t={onFetch:function(){$.mobile.showPageLoadingMsg(),u.info("Show "+e.title+" page message!"),i.showFlashMessage(e)},success:function(t,n){e.success&&e.success(t,n),f.onFetchSuccess(t,n,e)},error:function(t,n,r){f.onFetchError(t,n,r,e)},fetchUrl:e.url};s.getOrFetch(e.cacheKey,function(t){e.parse&&(t=e.parse(t)),r.views[e.view].entry.set(t),i.hideFlashMessage(e)},function(){t.onFetch&&t.onFetch(),r.views[e.view].entry.fetch(t)})},f.refreshSchedule=function(){i.resetFlashMessages("#schedule"),i.switchTitle("schedule","Planning"),f.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:t.getFullUrl("/"+a+"/schedule?callback=?"),cacheKey:"/"+a+"/schedule",dataType:"session",parse:function(e){return _(e).each(f.enhanceSession),e}})},f.refreshDay=function(e){i.resetFlashMessages("#day"),u.info("Processing day: "+e);var n=f.getEventDay(e),r=n?n.name:"Jour "+e;i.switchTitle("day",r),f.refreshDataList({page:"#day",title:r,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:t.getFullUrl("/"+a+"/schedule?callback=?"),cacheKey:"/"+a+"/schedule",dataType:"session",parse:function(e){return e=f.filterSessionsByDay(e,n),_(e).each(f.enhanceSession),e}})},f.refreshPresentations=function(){i.resetFlashMessages("#presentations"),u.info("Refreshing presentations"),i.switchTitle("presentations","Présentations"),f.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentations",template:$("#presentation-list-tpl").html(),url:t.getFullUrl("/"+a+"/presentations?callback=?"),cacheKey:"/"+a+"/presentations",dataType:"presentation",parse:function(e){return _(e).each(f.enhancePresentationListItem),e}})},f.refreshPresentation=function(e){i.resetFlashMessages("#presentation"),u.info("Processing presentation: "+e),i.switchTitle("presentation","Présentation"),f.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:t.getFullUrl("/"+a+"/presentations?callback=?"),cacheKey:"/"+a+"/presentations",dataType:"presentation",parse:function(t){var n=f.findPresentationById(t,e);return f.enhancePresentation(n),n},postRender:function(e){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),i.switchTitle("presentation",e.get("title"))}})},f.refreshSpeakers=function(){i.resetFlashMessages("#speakers"),u.info("Refreshing speakers"),i.switchTitle("speakers","Speakers"),f.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speakers",template:$("#speaker-list-tpl").html(),url:t.getFullUrl("/"+a+"/speakers?callback=?"),cacheKey:"/"+a+"/speakers",dataType:"speaker",parse:function(e){return e}})},f.refreshSpeaker=function(e){i.resetFlashMessages("#speaker"),u.info("Processing speaker: "+e),i.switchTitle("speaker","Speaker"),f.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:t.getFullUrl("/"+a+"/speakers?callback=?"),cacheKey:"/"+a+"/speakers",dataType:"speaker",parse:function(t){var n=f.findSpeakerById(t,e);return f.enhanceSpeaker(n),n},postRender:function(e){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var t=e.get("firstName")?e.get("firstName"):"";t+=e.get("firstName")&&e.get("lastName")?" ":"",t+=e.get("lastName")?e.get("lastName"):"",t&&i.switchTitle("speaker",t)}})},f.refreshTracks=function(){i.resetFlashMessages("#tracks"),u.info("Refreshing tracks"),i.switchTitle("tracks","Tracks"),f.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"tracks",template:$("#track-list-tpl").html(),url:t.getFullUrl("/"+a+"/tracks?callback=?"),cacheKey:"/"+a+"/tracks",dataType:"track",parse:function(e){return e}})},f.refreshTrack=function(e){i.resetFlashMessages("#track"),u.info("Refreshing track"),i.switchTitle("track","Track"),f.refreshDataList({page:"#track",title:"Track",el:"#track-presentation-list",view:"track",template:$("#presentation-list-tpl").html(),url:t.getFullUrl("/"+a+"/presentations?callback=?"),cacheKey:"/"+a+"/presentations",dataType:"presentation",parse:function(t){return t=f.filterPresentationsByTrackKey(t,e),_(t).each(f.enhancePresentationListItem),t},postRender:function(e){e.length>0&&i.switchTitle("track",e[0].get("track"))}})},f.refreshRooms=function(){i.resetFlashMessages("#rooms"),u.info("Refreshing rooms"),i.switchTitle("rooms","Salles"),f.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"rooms",template:$("#room-list-tpl").html(),url:t.getFullUrl("/"+a+"/rooms?callback=?"),cacheKey:"/"+a+"/rooms",dataType:"room",parse:function(e){return e}})},f.refreshRoom=function(e){i.resetFlashMessages("#room"),u.info("Refreshing room"),i.switchTitle("room","Room"),f.refreshDataList({page:"#room",title:"Room",el:"#room-presentation-list",view:"room",template:$("#presentation-list-tpl").html(),url:t.getFullUrl("/"+a+"/presentations?callback=?"),cacheKey:"/"+a+"/presentations",dataType:"presentation",parse:function(t){return t=f.filterPresentationsByRoomKey(t,e),_(t).each(f.enhancePresentationListItem),t},postRender:function(e){e.length>0&&i.switchTitle("room",e[0].get("room"))}})},f.renderEntryView=function(e,t,n,i,s){r.views[i.id].render()},f.renderCollectionView=function(e,t,r,i,s){n.views[i.id].render()},f.onFetchSuccess=function(e,t,n){e.get("statusCode")=="404"&&i.showFlashMessage(_.extend({type:"error",message:e.get("message")},n)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),i.hideFlashMessage(n)},0)},f.onFetchError=function(e,t,n,r){setTimeout(function(){u.info("Error response tmp: '"+t+"' for url: '"+r.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),i.hideFlashMessage(r),i.showFlashMessage(_.extend({type:"error",message:"No data found ..."},r))},0)},f.getParams=function(e){if(!e)return null;var t={},n,r=e.slice(e.indexOf("?")+1).split("&");return $.each(r,function(e,r){n=r.split("="),t[n[0]]?(t[n[0]]instanceof Array||(t[n[0]]=[t[n[0]]]),t[n[0]].push(n[1])):t[n[0]]=n[1]}),$.isEmptyObject(t)?null:t},f.getEventDay=function(e){var t=f.getEvent(a);return f.getDay(t,e)},f.enhanceSession=function(e){e.presentationUri&&(e.presentationId=f.getPresentationIdFromUri(e.presentationUri)),e.startTime=f.getScheduleTime(e.fromTime),e.endTime=f.getScheduleTime(e.toTime)},f.filterSessionsByDay=function(e,t){return _(e).filter(function(e){return t&&e.fromTime.substr(0,10)===t.date})},f.findEventById=function(e,t){return _(e).find(function(e){return e.id==t})},f.getPresentationIdFromUri=function(e){return Number(e.substring(e.lastIndexOf("/")+1))},f.getScheduleTime=function(e){return Date.parseExact(e,"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},f.enhancePresentationListItem=function(e){f.updateLanguage(e)},f.getSpeakerIdFromUri=function(e){return e.substring(e.lastIndexOf("/")+1)},f.enhancePresentation=function(e){f.updateLanguage(e),e.enhanced||(e.summary=f.formatPresentationSummary(e),e.enhanced=!0),_(e.speakers).each(function(e){e.id=e.id})},f.findPresentationById=function(e,t){return _(e).find(function(e){return e.id==t})},f.findSpeakerById=function(e,t){return _(e).find(function(e){return e.id==t})},f.enhanceSpeaker=function(e){e.enhanced||(e.bio=t.linkify(e.bio),e.enhanced=!0),_(e.talks).each(function(e){e.id=f.getPresentationIdFromUri(e.presentationUri)})},f.filterPresentationsByTrackKey=function(e,t){return t=t.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(e).filter(function(e){var n=e.track.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return n==t})},f.filterPresentationsByRoomKey=function(e,t){return t=t.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(e).filter(function(e){var n=e.room.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return n==t})},f.updateLanguage=function(e){e.language&&(e.language=e.language.toUpperCase())},f.onSynchronizeBeforePageShow=function(){o.beforePageShow(f.clearPageContexts)},f.formatPresentationSummary=function(e){return t.linkify(e.summary.replace(/\n/g,"<br />"))},f.getDetailView=function(e){return r.views[e]},u.info("Loaded core"),f.addUrlsForEvent(a),f});