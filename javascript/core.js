define(["log","utils","collection","entry","register","ui","db","synchronize"],function(a,b,c,d,e,f,g,h){function t(a,b,c,d,e,f,g){var h=p.getParams(b[1]);o.getPageContextValue(d.id,"id")!==h.id?(o.setPageContextValue(d.id,"initialized",!0),o.setPageContextValue(d.id,"id",h.id),f(h.id)):g&&g(a,b,c,d,e)}function u(a,b,c,d,e,f,g){var h=p.getParams(b[1]);o.getPageContextValue(d.id,"initialized")?g&&g(a,b,c,d,e):(o.setPageContextValue(d.id,"initialized",!0),f(h))}function v(a,b,c,d,e,f){var g=p.getParams(b[1]);f(g)}var i=a.getLogger("core");i.info("Loading core.js");var j="6",k="xebiaFr",l="devoxxFR",m=k,n=[k,l],o={},p,q={ids:[]};g.get("favorites",function(a){a&&(q=a)});var r={events:[{id:"6",name:"Devoxx France 2012",days:[{id:"1",name:"Mercredi 18 Avril",date:"2012-04-18"},{id:"2",name:"Jeudi 19 Avril",date:"2012-04-19"},{id:"3",name:"Vendredi 20 Avril",date:"2012-04-20"}]}]};o.getEvent=function(a){return _(r.events).find(function(b){return b.id==a})},o.getDay=function(a,b){return _(a.days).find(function(a){return a.id==b})};var s={};return o.createPageContext=function(a){s[a]={initialized:!1}},o.initializePageContextIfNecessary=function(a){s[a]||o.createPageContext(a)},o.getPageContextValue=function(a,b){return o.initializePageContextIfNecessary(a),s[a][b]},o.getPageContexts=function(){return s},o.setPageContextValue=function(a,b,c){o.initializePageContextIfNecessary(a),s[a][b]=c},o.clearPageContexts=function(){_(o.getPageContexts()).each(function(a){a.id&&(a.id=undefined),a.initialized&&(a.initialized=!1)})},o.addUrlsForEvent=function(a){h.addUrl("/events/"+a+"/schedule",b.getFullUrl("/events/"+a+"/schedule?callback=?")),h.addUrl("/events/"+a+"/presentations",b.getFullUrl("/events/"+a+"/presentations?callback=?")),h.addUrl("/events/"+a+"/schedule/rooms",b.getFullUrl("/events/"+a+"/schedule/rooms?callback=?")),h.addUrl("/events/"+a+"/tracks",b.getFullUrl("/events/"+a+"/tracks?callback=?")),h.addUrl("/events/"+a+"/speakers",b.getFullUrl("/events/"+a+"/speakers?callback=?")),h.addUrl("/events",b.getFullUrl("/events?callback=?"))},o.setupRouter=function(){i.info("Instanciating jqmr router"),p=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))":{handler:"onBeforeDayPageShow",events:"bs"},"#events":{handler:"onBeforeEventsPageShow",events:"bs"},"#event(?:[?](.*))":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomsPageShow",events:"bs"},"#room(?:[?](.*))":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#track(?:[?](.*))":{handler:"onBeforeTrackPageShow",events:"bs"},"#register":{handler:"onBeforeRegisterPageShow",events:"bs"},"#synchronize":{handler:"onBeforeSynchronizePageShow",events:"bs"},"#twitter(?:[?](.*))?":{handler:"onBeforeTwitterPageShow",events:"bs"},"#xebia-program":{handler:"onBeforeXebiaProgramPageShow",events:"bs"}},{onBeforeSchedulePageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshSchedule,o.renderCollectionView)},onBeforeDayPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshDay,o.renderCollectionView)},onBeforeEventsPageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshEvents)},onBeforeEventPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshEvent)},onBeforeRoomsPageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshRooms)},onBeforeRoomPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshRoom,o.renderCollectionView)},onBeforeTracksPageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshTracks)},onBeforeTrackPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshTrack,o.renderCollectionView)},onBeforePresentationsPageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshPresentations,o.renderCollectionView)},onBeforePresentationPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshPresentation,o.renderEntryView)},onBeforeSpeakersPageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.refreshSpeakers)},onBeforeSpeakerPageShow:function(a,b,c,d,e){t(a,b,c,d,e,o.refreshSpeaker)},onBeforeRegisterPageShow:function(a,b,c,d,e){v(a,b,c,d,e,o.onRegisterBeforePageShow)},onBeforeSynchronizePageShow:function(a,b,c,d,e){u(a,b,c,d,e,o.onSynchronizeBeforePageShow)},onBeforeTwitterPageShow:function(a,b,c,d,e){v(a,b,c,d,e,o.refreshTwitter)},onBeforeXebiaProgramPageShow:function(a,b,c,d,e){v(a,b,c,d,e,o.refreshXebiaProgram)}}),i.info("Instanciated jqmr router")},o.refreshDataList=function(a){i.info("Loading "+a.title+" View"),c.views[a.view]=new c.EntryListView({dataType:a.dataType,fetchUrl:a.url,el:a.el,collectionTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.parse&&a.parse(b),b},view:a.view,postRender:a.postRender}),c.views[a.view].collection.length!==0&&c.views[a.view].collection.reset([]),i.info("Fetch "+a.title+" Data from url: '"+c.views[a.view].collection.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),f.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),o.onFetchSuccess(b,c,a)},error:function(b,c,d){o.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),c.views[a.view].collection.reset(b),f.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),c.views[a.view].el.empty(),c.views[a.view].collection.fetch(b)})},o.refreshDataEntry=function(a){i.info("Loading "+a.title+" View"),d.views[a.view]=new d.EntryView({dataType:a.dataType,fetchUrl:a.url,el:a.el,entryTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.parse&&a.parse(b),b},postRender:a.postRender,view:a.view}),d.views[a.view].entry&&d.views[a.view].entry.clear(),i.info("Fetch "+a.title+" Data from url: '"+d.views[a.view].entry.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),i.info("Show "+a.title+" page message!"),f.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),o.onFetchSuccess(b,c,a)},error:function(b,c,d){o.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),d.views[a.view].entry.set(b),f.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),d.views[a.view].entry.fetch(b)})},o.refreshSchedule=function(){f.resetFlashMessages("#schedule"),f.switchTitle("schedule","Planning"),o.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule?callback=?"),cacheKey:"/events/"+j+"/schedule",dataType:"session",parse:function(a){return _(a).each(o.enhanceSession),a},postRender:function(a){o.initSwipeFavorites("presentation-schedule-item")}})},o.refreshDay=function(a){f.resetFlashMessages("#day"),i.info("Processing day: "+a);var c=o.getEventDay(a),d=c?c.name:"Jour "+a;f.switchTitle("day",d),o.refreshDataList({page:"#day",title:d,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule?callback=?"),cacheKey:"/events/"+j+"/schedule",dataType:"session",parse:function(a){return a=o.filterSessionsByDay(a,c),_(a).each(o.enhanceSession),a},postRender:function(a){o.initSwipeFavorites("presentation-day-item")}})},o.refreshEvents=function(){f.resetFlashMessages("#events"),i.info("Refreshing events"),f.switchTitle("events","Evénements"),o.refreshDataList({page:"#events",title:"Event",el:"#event-list",view:"events",template:$("#event-list-tpl").html(),url:b.getFullUrl("/events?callback=?"),cacheKey:"/events",dataType:"event",parse:function(a){return a}})},o.refreshEvent=function(a){f.resetFlashMessages("#event"),i.info("Processing event: "+a),f.switchTitle("event","Evénement"),o.refreshDataEntry({page:"#event",title:"Event",el:"#event-content",view:"event",template:$("#event-tpl").html(),url:b.getFullUrl("/events?callback=?"),cacheKey:"/events",dataType:"event",parse:function(b){return o.findEventById(b,a)},postRender:function(a){$("#event-details-list").listview(),f.switchTitle("event",a.get("name"))}})},o.refreshPresentations=function(){f.resetFlashMessages("#presentations"),i.info("Refreshing presentations"),f.switchTitle("presentations","Présentations"),o.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentations",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",dataType:"presentation",parse:function(a){return _(a).each(o.enhancePresentationListItem),a},postRender:function(a){o.initSwipeFavorites("presentation-item")}})},o.refreshPresentation=function(a){f.resetFlashMessages("#presentation"),i.info("Processing presentation: "+a),f.switchTitle("presentation","Présentation"),o.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",dataType:"presentation",parse:function(b){var c=o.findPresentationById(b,a);return o.enhancePresentation(c),c},postRender:function(a){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),f.switchTitle("presentation",a.get("title"))}})},o.refreshSpeakers=function(){f.resetFlashMessages("#tracks"),i.info("Refreshing speakers"),f.switchTitle("speakers","Speakers"),o.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speakers",template:$("#speaker-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/speakers?callback=?"),cacheKey:"/events/"+j+"/speakers",dataType:"speaker",parse:function(a){return a}})},o.refreshSpeaker=function(a){f.resetFlashMessages("#speaker"),i.info("Processing speaker: "+a),f.switchTitle("speaker","Speaker"),o.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:b.getFullUrl("/events/"+j+"/speakers?callback=?"),cacheKey:"/events/"+j+"/speakers",dataType:"speaker",parse:function(b){var c=o.findSpeakerById(b,a);return o.enhanceSpeaker(c),c},postRender:function(a){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var b=a.get("firstName")?a.get("firstName"):"";b+=a.get("firstName")&&a.get("lastName")?" ":"",b+=a.get("lastName")?a.get("lastName"):"",b&&f.switchTitle("speaker",b)}})},o.refreshTracks=function(){f.resetFlashMessages("#tracks"),i.info("Refreshing tracks"),f.switchTitle("tracks","Tracks"),o.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"tracks",template:$("#track-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/tracks?callback=?"),cacheKey:"/events/"+j+"/tracks",dataType:"track",parse:function(a){return a}})},o.refreshTrack=function(a){f.resetFlashMessages("#track"),i.info("Refreshing track"),f.switchTitle("track","Track"),o.refreshDataList({page:"#track",title:"Track",el:"#track-presentation-list",view:"track",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",dataType:"presentation",parse:function(b){return b=o.filterPresentationsByTrackId(b,a),_(b).each(o.enhancePresentationListItem),b},postRender:function(a){a.length>0&&f.switchTitle("track",a[0].get("track")),o.initSwipeFavorites("presentation-item")}})},o.refreshRooms=function(){f.resetFlashMessages("#rooms"),i.info("Refreshing rooms"),f.switchTitle("rooms","Salles"),o.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"rooms",template:$("#room-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule/rooms?callback=?"),cacheKey:"/events/"+j+"/schedule/rooms",dataType:"room",parse:function(a){return a}})},o.refreshRoom=function(a){f.resetFlashMessages("#room"),i.info("Refreshing room"),f.switchTitle("room","Room"),o.refreshDataList({page:"#room",title:"Room",el:"#room-presentation-list",view:"room",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",dataType:"presentation",parse:function(b){return b=o.filterPresentationsByRoomId(b,a),_(b).each(o.enhancePresentationListItem),b},postRender:function(a){a.length>0&&f.switchTitle("room",a[0].get("room")),o.initSwipeFavorites("presentation-item")}})},o.renderEntryView=function(a,b,c,e,f){d.views[e.id].render()},o.renderCollectionView=function(a,b,d,e,f){c.views[e.id].render()},o.onFetchSuccess=function(a,b,c){a.get("statusCode")=="404"&&f.showFlashMessage(_.extend({type:"error",message:a.get("message")},c)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(c)},0)},o.onFetchError=function(a,b,c,d){setTimeout(function(){i.info("Error response tmp: '"+b+"' for url: '"+d.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(d),f.showFlashMessage(_.extend({type:"error",message:"No data found ..."},d))},0)},o.getParams=function(a){if(!a)return null;var b={},c,d=a.slice(a.indexOf("?")+1).split("&");return $.each(d,function(a,d){c=d.split("="),b[c[0]]?(b[c[0]]instanceof Array||(b[c[0]]=[b[c[0]]]),b[c[0]].push(c[1])):b[c[0]]=c[1]}),$.isEmptyObject(b)?null:b},o.getEventDay=function(a){var b=o.getEvent(j);return o.getDay(b,a)},o.enhanceSession=function(a){a.presentationUri&&(a.presentationId=o.getPresentationIdFromUri(a.presentationUri),a.favorite=o.isFavorite(a.presentationId)),a.startTime=o.getScheduleTime(a.fromTime),a.endTime=o.getScheduleTime(a.toTime)},o.filterSessionsByDay=function(a,b){return _(a).filter(function(a){return b&&a.fromTime.substr(0,10)===b.date})},o.findEventById=function(a,b){return _(a).find(function(a){return a.id==b})},o.getPresentationIdFromUri=function(a){return Number(a.substring(a.lastIndexOf("/")+1))},o.getScheduleTime=function(a){return Date.parseExact(a.substring(0,a.lastIndexOf(".")),"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},o.enhancePresentationListItem=function(a){o.updateLanguage(a),o.updateFavorite(a)},o.getSpeakerIdFromUri=function(a){return a.substring(a.lastIndexOf("/")+1)},o.enhancePresentation=function(a){o.updateLanguage(a),o.updateFavorite(a),a.enhanced||(a.summary=o.formatPresentationSummary(a),a.enhanced=!0),_(a.speakers).each(function(a){a.id=o.getSpeakerIdFromUri(a.speakerUri)})},o.findPresentationById=function(a,b){return _(a).find(function(a){return a.id==b})},o.findSpeakerById=function(a,b){return _(a).find(function(a){return a.id==b})},o.enhanceSpeaker=function(a){a.enhanced||(a.bio=b.linkify(a.bio),a.enhanced=!0),_(a.talks).each(function(a){a.id=o.getPresentationIdFromUri(a.presentationUri)})},o.filterPresentationsByTrackId=function(a,b){return _(a).filter(function(a){return a.trackId==b})},o.filterPresentationsByRoomId=function(a,b){return _(a).filter(function(a){return a.roomId==b})},o.updateLanguage=function(a){a.language&&(a.language=a.language.toUpperCase())},o.updateFavorite=function(a){a.favorite=o.isFavorite(a.id)},o.onRegisterBeforePageShow=function(){e.beforePageShow()},o.onSynchronizeBeforePageShow=function(){h.beforePageShow(o.clearPageContexts)},o.refreshTwitter=function(a){var c=a?a.screenname:undefined;_(n).contains(c)||(c=m),$(c===k?"#twitter-devoxxfr":"#twitter-xebiafr").removeClass("ui-btn-active"),$(c===k?"#twitter-xebiafr":"#twitter-devoxxfr").addClass("ui-btn-active"),console.log("Requested screen name : "+c),f.resetFlashMessages("#twitter"),i.info("Processing tweets"),$(".ui-title").html('<img src="image/twitter-white-transparent.png" class="twitter-header-img" style="height:18px;" />'),o.refreshDataList({page:"#twitter",title:"Twitter",el:"#twitter-timeline",view:"twitter",template:$("#twitter-timeline-tpl").html(),url:b.getTwitterFullUrl("/twitter/"+c+"?callback=?"),parse:function(a){return _(a).each(function(a){a.formattedDate=o.getTweetFormattedDate(a),a.user.icon=o.getTwitterUserImage(a.user),a.htmlText=o.twitter_linkify(a.text)}),a}})},o.getTweetFormattedDate=function(a){return Date.parse(a.created_at)?Date.parse(a.created_at).toString("HH:mm"):"--:--"},o.getTwitterUserImage=function(a){return a.profile_image_url.replace(/_normal(\.[^\.]+)$/,"$1")},o.refreshXebiaProgram=function(a){f.resetFlashMessages("#xebia-program"),i.info("Refreshing Xebia Program"),o.refreshDataList({page:"#xebia-program",title:"Programme Xebia",el:"#xebia-program-list",view:"xebia-program",template:$("#xebia-program-list-tpl").html(),url:"http://devoxx-xebia.cloudfoundry.com/xebia/program?callback=?",cacheKey:"/xebia/program",parse:function(a){return a}})},o.twitter_linkify=function(a){return a=a.replace(/(https?:\/\/\S+)/gi,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)@(\w+)/gi,function(a){return'<a href="http://twitter.com/'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)#(\w+)/gi,function(a){return'<a href="http://search.twitter.com/search?q='+a.replace(/#/,"%23")+'" target="_blank">'+a+"</a>"}),a},o.formatPresentationSummary=function(a){return b.linkify(a.summary.replace(/\n/g,"<br />"))},o.saveFavorites=function(){i.info("Favorite ids: "+q.ids),g.save("favorites",q)},o.removeFavorite=function(a){o.isFavorite(a)&&(q.ids.splice(q.ids.indexOf(a),1),o.saveFavorites(),o.updatePresentationModelFavoriteValue(!1),o.updatePresentationFavoriteListItem(a,!1))},o.addFavorite=function(a){o.isFavorite(a)||(q.ids.push(a),o.saveFavorites(),o.updatePresentationModelFavoriteValue(!0),o.updatePresentationFavoriteListItem(a,!0))},o.toggleFavorite=function(a){return a=Number(a),o.isFavorite(a)?(o.removeFavorite(a),!1):(o.addFavorite(a),!0)},o.isFavorite=function(a){return q&&_(q.ids).contains(Number(a))},o.updatePresentationModelFavoriteValue=function(a){var b=o.getDetailView("presentation");b&&(b.entry.attributes.favorite=a)},o.initSwipeFavorites=function(a){$("ul li."+a).bind("swipeleft",function(a){var b=$(this),c=Number(b.attr("data-presentation-id"));o.removeFavorite(c),b.removeClass("ui-btn-up-e"),b.addClass("ui-btn-up-c"),b.attr("data-theme","c")}),$("ul li."+a).bind("swiperight",function(a){var b=$(this),c=Number(b.attr("data-presentation-id"));o.addFavorite(c),b.removeClass("ui-btn-up-c"),b.addClass("ui-btn-up-e"),b.attr("data-theme","e")})},o.getDetailView=function(a){return d.views[a]},o.onFavoriteStarClick=function(a){o.toggleFavorite(a),o.getDetailView("presentation").render()},o.updatePresentationFavoriteListItem=function(a,b){_(c.views).each(function(c){if(c.collection.dataType)if(c.collection.dataType=="session"){var d=_(c.collection.models).find(function(b){return b.attributes.presentationId&&b.attributes.presentationId==a});d&&(d.attributes.favorite=b)}else if(c.collection.dataType=="presentation"){var e=_(c.collection.models).find(function(b){return d.attributes.id&&d.attributes.id==a});e&&(e.attributes.favorite=b)}})},i.info("Loaded core"),o.addUrlsForEvent(j),o})