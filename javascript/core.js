define(["log","utils","collection","entry","ui","db","synchronize"],function(a,b,c,d,e,f,g){function n(a,b,c,d,e,f,g){var h=k.getParams(b[1]);j.getPageContextValue(d.id,"id")!==h.id?(j.setPageContextValue(d.id,"initialized",!0),j.setPageContextValue(d.id,"id",h.id),f(h.id)):g&&g(a,b,c,d,e)}function o(a,b,c,d,e,f,g){var h=k.getParams(b[1]);j.getPageContextValue(d.id,"initialized")?g&&g(a,b,c,d,e):(j.setPageContextValue(d.id,"initialized",!0),f(h))}function p(a,b,c,d,e,f){var g=k.getParams(b[1]);f(g)}var h=a.getLogger("core");h.info("Loading core.js");var i="11",j={},k,l={events:[{id:"11",name:"Devoxx France 2014",days:[{id:"1",name:"Mercredi 16 Avril",date:"2014-04-16"},{id:"2",name:"Jeudi 17 Avril",date:"2014-04-17"},{id:"3",name:"Vendredi 18 Avril",date:"2014-04-18"}]}]};j.getEvent=function(a){return _(l.events).find(function(b){return b.id==a})},j.getDay=function(a,b){return _(a.days).find(function(a){return a.id==b})};var m={};return j.createPageContext=function(a){m[a]={initialized:!1}},j.initializePageContextIfNecessary=function(a){m[a]||j.createPageContext(a)},j.getPageContextValue=function(a,b){return j.initializePageContextIfNecessary(a),m[a][b]},j.getPageContexts=function(){return m},j.setPageContextValue=function(a,b,c){j.initializePageContextIfNecessary(a),m[a][b]=c},j.clearPageContexts=function(){_(j.getPageContexts()).each(function(a){a.id&&(a.id=undefined),a.initialized&&(a.initialized=!1)})},j.addUrlsForEvent=function(a){g.addUrl(a+"/schedule",b.getFullUrl("/"+a+"/schedule?callback=?")),g.addUrl(a+"/presentations",b.getFullUrl("/"+a+"/presentations?callback=?")),g.addUrl(a+"/rooms",b.getFullUrl("/"+a+"/rooms?callback=?")),g.addUrl(a+"/tracks",b.getFullUrl("/"+a+"/tracks?callback=?")),g.addUrl(a+"/speakers",b.getFullUrl("/"+a+"/speakers?callback=?"))},j.setupRouter=function(){h.info("Instanciating jqmr router"),k=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))":{handler:"onBeforeDayPageShow",events:"bs"},"#event(?:[?](.*))":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomsPageShow",events:"bs"},"#room(?:[?](.*))":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#track(?:[?](.*))":{handler:"onBeforeTrackPageShow",events:"bs"},"#synchronize":{handler:"onBeforeSynchronizePageShow",events:"bs"}},{onBeforeSchedulePageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.refreshSchedule,j.renderCollectionView)},onBeforeDayPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshDay,j.renderCollectionView)},onBeforeEventPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshEvent)},onBeforeRoomsPageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.refreshRooms)},onBeforeRoomPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshRoom,j.renderCollectionView)},onBeforeTracksPageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.refreshTracks)},onBeforeTrackPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshTrack,j.renderCollectionView)},onBeforePresentationsPageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.refreshPresentations,j.renderCollectionView)},onBeforePresentationPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshPresentation,j.renderEntryView)},onBeforeSpeakersPageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.refreshSpeakers)},onBeforeSpeakerPageShow:function(a,b,c,d,e){n(a,b,c,d,e,j.refreshSpeaker)},onBeforeSynchronizePageShow:function(a,b,c,d,e){o(a,b,c,d,e,j.onSynchronizeBeforePageShow)}}),h.info("Instanciated jqmr router")},j.refreshDataList=function(a){h.info("Loading "+a.title+" View"),c.views[a.view]=new c.EntryListView({dataType:a.dataType,fetchUrl:a.url,el:a.el,collectionTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&f.save(a.cacheKey,b),a.parse&&(b=a.parse(b)),b},view:a.view,postRender:a.postRender}),c.views[a.view].collection.length!==0&&c.views[a.view].collection.reset([]),h.info("Fetch "+a.title+" Data from url: '"+c.views[a.view].collection.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),e.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),j.onFetchSuccess(b,c,a)},error:function(b,c,d){j.onFetchError(b,c,d,a)},fetchUrl:a.url};f.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),c.views[a.view].collection.reset(b),e.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),c.views[a.view].el.empty(),c.views[a.view].collection.fetch(b)})},j.refreshDataEntry=function(a){h.info("Loading "+a.title+" View"),d.views[a.view]=new d.EntryView({dataType:a.dataType,fetchUrl:a.url,el:a.el,entryTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&f.save(a.cacheKey,b),a.parse&&(b=a.parse(b)),b},postRender:a.postRender,view:a.view}),d.views[a.view].entry&&d.views[a.view].entry.clear(),h.info("Fetch "+a.title+" Data from url: '"+d.views[a.view].entry.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),h.info("Show "+a.title+" page message!"),e.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),j.onFetchSuccess(b,c,a)},error:function(b,c,d){j.onFetchError(b,c,d,a)},fetchUrl:a.url};f.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),d.views[a.view].entry.set(b),e.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),d.views[a.view].entry.fetch(b)})},j.refreshSchedule=function(){e.resetFlashMessages("#schedule"),e.switchTitle("schedule","Planning"),j.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/"+i+"/schedule?callback=?"),cacheKey:"/"+i+"/schedule",dataType:"session",parse:function(a){return _(a).each(j.enhanceSession),a}})},j.refreshDay=function(a){e.resetFlashMessages("#day"),h.info("Processing day: "+a);var c=j.getEventDay(a),d=c?c.name:"Jour "+a;e.switchTitle("day",d),j.refreshDataList({page:"#day",title:d,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/"+i+"/schedule?callback=?"),cacheKey:"/"+i+"/schedule",dataType:"session",parse:function(a){return a=j.filterSessionsByDay(a,c),_(a).each(j.enhanceSession),a}})},j.refreshPresentations=function(){e.resetFlashMessages("#presentations"),h.info("Refreshing presentations"),e.switchTitle("presentations","Présentations"),j.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentations",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+i+"/presentations?callback=?"),cacheKey:"/"+i+"/presentations",dataType:"presentation",parse:function(a){return _(a).each(j.enhancePresentationListItem),a}})},j.refreshPresentation=function(a){e.resetFlashMessages("#presentation"),h.info("Processing presentation: "+a),e.switchTitle("presentation","Présentation"),j.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:b.getFullUrl("/"+i+"/presentations?callback=?"),cacheKey:"/"+i+"/presentations",dataType:"presentation",parse:function(b){var c=j.findPresentationById(b,a);return j.enhancePresentation(c),c},postRender:function(a){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),e.switchTitle("presentation",a.get("title"))}})},j.refreshSpeakers=function(){e.resetFlashMessages("#speakers"),h.info("Refreshing speakers"),e.switchTitle("speakers","Speakers"),j.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speakers",template:$("#speaker-list-tpl").html(),url:b.getFullUrl("/"+i+"/speakers?callback=?"),cacheKey:"/"+i+"/speakers",dataType:"speaker",parse:function(a){return a}})},j.refreshSpeaker=function(a){e.resetFlashMessages("#speaker"),h.info("Processing speaker: "+a),e.switchTitle("speaker","Speaker"),j.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:b.getFullUrl("/"+i+"/speakers?callback=?"),cacheKey:"/"+i+"/speakers",dataType:"speaker",parse:function(b){var c=j.findSpeakerById(b,a);return j.enhanceSpeaker(c),c},postRender:function(a){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var b=a.get("firstName")?a.get("firstName"):"";b+=a.get("firstName")&&a.get("lastName")?" ":"",b+=a.get("lastName")?a.get("lastName"):"",b&&e.switchTitle("speaker",b)}})},j.refreshTracks=function(){e.resetFlashMessages("#tracks"),h.info("Refreshing tracks"),e.switchTitle("tracks","Tracks"),j.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"tracks",template:$("#track-list-tpl").html(),url:b.getFullUrl("/"+i+"/tracks?callback=?"),cacheKey:"/"+i+"/tracks",dataType:"track",parse:function(a){return a}})},j.refreshTrack=function(a){e.resetFlashMessages("#track"),h.info("Refreshing track"),e.switchTitle("track","Track"),j.refreshDataList({page:"#track",title:"Track",el:"#track-presentation-list",view:"track",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+i+"/presentations?callback=?"),cacheKey:"/"+i+"/presentations",dataType:"presentation",parse:function(b){return b=j.filterPresentationsByTrackKey(b,a),_(b).each(j.enhancePresentationListItem),b},postRender:function(a){a.length>0&&e.switchTitle("track",a[0].get("track"))}})},j.refreshRooms=function(){e.resetFlashMessages("#rooms"),h.info("Refreshing rooms"),e.switchTitle("rooms","Salles"),j.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"rooms",template:$("#room-list-tpl").html(),url:b.getFullUrl("/"+i+"/rooms?callback=?"),cacheKey:"/"+i+"/rooms",dataType:"room",parse:function(a){return a}})},j.refreshRoom=function(a){e.resetFlashMessages("#room"),h.info("Refreshing room"),e.switchTitle("room","Room"),j.refreshDataList({page:"#room",title:"Room",el:"#room-presentation-list",view:"room",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+i+"/presentations?callback=?"),cacheKey:"/"+i+"/presentations",dataType:"presentation",parse:function(b){return b=j.filterPresentationsByRoomKey(b,a),_(b).each(j.enhancePresentationListItem),b},postRender:function(a){a.length>0&&e.switchTitle("room",a[0].get("room"))}})},j.renderEntryView=function(a,b,c,e,f){d.views[e.id].render()},j.renderCollectionView=function(a,b,d,e,f){c.views[e.id].render()},j.onFetchSuccess=function(a,b,c){a.get("statusCode")=="404"&&e.showFlashMessage(_.extend({type:"error",message:a.get("message")},c)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),e.hideFlashMessage(c)},0)},j.onFetchError=function(a,b,c,d){setTimeout(function(){h.info("Error response tmp: '"+b+"' for url: '"+d.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),e.hideFlashMessage(d),e.showFlashMessage(_.extend({type:"error",message:"No data found ..."},d))},0)},j.getParams=function(a){if(!a)return null;var b={},c,d=a.slice(a.indexOf("?")+1).split("&");return $.each(d,function(a,d){c=d.split("="),b[c[0]]?(b[c[0]]instanceof Array||(b[c[0]]=[b[c[0]]]),b[c[0]].push(c[1])):b[c[0]]=c[1]}),$.isEmptyObject(b)?null:b},j.getEventDay=function(a){var b=j.getEvent(i);return j.getDay(b,a)},j.enhanceSession=function(a){a.presentationUri&&(a.presentationId=j.getPresentationIdFromUri(a.presentationUri)),a.startTime=j.getScheduleTime(a.fromTime),a.endTime=j.getScheduleTime(a.toTime)},j.filterSessionsByDay=function(a,b){return _(a).filter(function(a){return b&&a.fromTime.substr(0,10)===b.date})},j.findEventById=function(a,b){return _(a).find(function(a){return a.id==b})},j.getPresentationIdFromUri=function(a){return Number(a.substring(a.lastIndexOf("/")+1))},j.getScheduleTime=function(a){return Date.parseExact(a,"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},j.enhancePresentationListItem=function(a){j.updateLanguage(a)},j.getSpeakerIdFromUri=function(a){return a.substring(a.lastIndexOf("/")+1)},j.enhancePresentation=function(a){j.updateLanguage(a),a.enhanced||(a.summary=j.formatPresentationSummary(a),a.enhanced=!0),_(a.speakers).each(function(a){a.id=a.id})},j.findPresentationById=function(a,b){return _(a).find(function(a){return a.id==b})},j.findSpeakerById=function(a,b){return _(a).find(function(a){return a.id==b})},j.enhanceSpeaker=function(a){a.enhanced||(a.bio=b.linkify(a.bio),a.enhanced=!0),_(a.talks).each(function(a){a.id=j.getPresentationIdFromUri(a.presentationUri)})},j.filterPresentationsByTrackKey=function(a,b){return b=b.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(a).filter(function(a){var c=a.track.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return c==b})},j.filterPresentationsByRoomKey=function(a,b){return b=b.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(a).filter(function(a){var c=a.room.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return c==b})},j.updateLanguage=function(a){a.language&&(a.language=a.language.toUpperCase())},j.onSynchronizeBeforePageShow=function(){g.beforePageShow(j.clearPageContexts)},j.formatPresentationSummary=function(a){return b.linkify(a.summary.replace(/\n/g,"<br />"))},j.getDetailView=function(a){return d.views[a]},h.info("Loaded core"),j.addUrlsForEvent(i),j})