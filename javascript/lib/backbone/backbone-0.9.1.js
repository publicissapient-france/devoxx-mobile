//     (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Backbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org

(function(e,t){typeof exports!="undefined"?t(e,exports,require("underscore")):typeof define=="function"&&define.amd?define(["underscore","jquery","exports"],function(n,r,i){e.Backbone=t(e,i,n,r)}):e.Backbone=t(e,{},e._,e.jQuery||e.Zepto||e.ender)})(this,function(e,t,n,r){var i=e.Backbone,s=Array.prototype.slice,o=Array.prototype.splice;t.VERSION="0.9.1",t.setDomLibrary=function(e){r=e},t.noConflict=function(){return e.Backbone=i,t},t.emulateHTTP=!1,t.emulateJSON=!1,t.Events={on:function(e,t,n){var r;e=e.split(/\s+/);var i=this._callbacks||(this._callbacks={});while(r=e.shift()){var s=i[r]||(i[r]={}),o=s.tail||(s.tail=s.next={});o.callback=t,o.context=n,s.tail=o.next={}}return this},off:function(e,t,n){var r,i,s;if(!e)delete this._callbacks;else if(i=this._callbacks){e=e.split(/\s+/);while(r=e.shift()){s=i[r],delete i[r];if(!t||!s)continue;while((s=s.next)&&s.next){if(s.callback===t&&(!n||s.context===n))continue;this.on(r,s.callback,s.context)}}}return this},trigger:function(e){var t,n,r,i,o,u,a;if(!(r=this._callbacks))return this;u=r.all,(e=e.split(/\s+/)).push(null);while(t=e.shift()){u&&e.push({next:u.next,tail:u.tail,event:t});if(!(n=r[t]))continue;e.push({next:n.next,tail:n.tail})}a=s.call(arguments,1);while(n=e.pop()){i=n.tail,o=n.event?[n.event].concat(a):a;while((n=n.next)!==i)n.callback.apply(n.context||this,o)}return this}},t.Events.bind=t.Events.on,t.Events.unbind=t.Events.off,t.Model=function(e,t){var r;e||(e={}),t&&t.parse&&(e=this.parse(e));if(r=w(this,"defaults"))e=n.extend({},r,e);t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=n.uniqueId("c");if(!this.set(e,{silent:!0}))throw new Error("Can't create an invalid model");delete this._changed,this._previousAttributes=n.clone(this.attributes),this.initialize.apply(this,arguments)},n.extend(t.Model.prototype,t.Events,{idAttribute:"id",initialize:function(){},toJSON:function(){return n.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var r=this.attributes[e];return this._escapedAttributes[e]=n.escape(r==null?"":""+r)},has:function(e){return this.attributes[e]!=null},set:function(e,r,i){var s,o,u;n.isObject(e)||e==null?(s=e,i=r):(s={},s[e]=r),i||(i={});if(!s)return this;s instanceof t.Model&&(s=s.attributes);if(i.unset)for(o in s)s[o]=void 0;if(!this._validate(s,i))return!1;this.idAttribute in s&&(this.id=s[this.idAttribute]);var a=this.attributes,f=this._escapedAttributes,l=this._previousAttributes||{},c=this._setting;this._changed||(this._changed={}),this._setting=!0;for(o in s){u=s[o],n.isEqual(a[o],u)||delete f[o],i.unset?delete a[o]:a[o]=u,this._changing&&!n.isEqual(this._changed[o],u)&&(this.trigger("change:"+o,this,u,i),this._moreChanges=!0),delete this._changed[o];if(!n.isEqual(l[o],u)||n.has(a,o)!=n.has(l,o))this._changed[o]=u}return c||(!i.silent&&this.hasChanged()&&this.change(i),this._setting=!1),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(n.clone(this.attributes),e)},fetch:function(e){e=e?n.clone(e):{};var r=this,i=e.success;return e.success=function(t,n,s){if(!r.set(r.parse(t,s),e))return!1;i&&i(r,t)},e.error=t.wrapError(e.error,r,e),(this.sync||t.sync).call(this,"read",this,e)},save:function(e,r,i){var s,o;n.isObject(e)||e==null?(s=e,i=r):(s={},s[e]=r),i=i?n.clone(i):{},i.wait&&(o=n.clone(this.attributes));var u=n.extend({},i,{silent:!0});if(s&&!this.set(s,i.wait?u:i))return!1;var a=this,f=i.success;i.success=function(e,t,r){var o=a.parse(e,r);i.wait&&(o=n.extend(s||{},o));if(!a.set(o,i))return!1;f?f(a,e):a.trigger("sync",a,e,i)},i.error=t.wrapError(i.error,a,i);var l=this.isNew()?"create":"update",c=(this.sync||t.sync).call(this,l,this,i);return i.wait&&this.set(o,u),c},destroy:function(e){e=e?n.clone(e):{};var r=this,i=e.success,s=function(){r.trigger("destroy",r,r.collection,e)};if(this.isNew())return s();e.success=function(t){e.wait&&s(),i?i(r,t):r.trigger("sync",r,t,e)},e.error=t.wrapError(e.error,r,e);var o=(this.sync||t.sync).call(this,"delete",this,e);return e.wait||s(),o},url:function(){var e=w(this.collection,"url")||w(this,"urlRoot")||E();return this.isNew()?e:e+(e.charAt(e.length-1)=="/"?"":"/")+encodeURIComponent(this.id)},parse:function(e,t){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},change:function(e){if(this._changing||!this.hasChanged())return this;this._changing=!0,this._moreChanges=!0;for(var t in this._changed)this.trigger("change:"+t,this,this._changed[t],e);while(this._moreChanges)this._moreChanges=!1,this.trigger("change",this,e);return this._previousAttributes=n.clone(this.attributes),delete this._changed,this._changing=!1,this},hasChanged:function(e){return arguments.length?this._changed&&n.has(this._changed,e):!n.isEmpty(this._changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?n.clone(this._changed):!1;var t,r=!1,i=this._previousAttributes;for(var s in e){if(n.isEqual(i[s],t=e[s]))continue;(r||(r={}))[s]=t}return r},previous:function(e){return!arguments.length||!this._previousAttributes?null:this._previousAttributes[e]},previousAttributes:function(){return n.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=n.extend({},this.attributes,e);var r=this.validate(e,t);return r?(t&&t.error?t.error(this,r,t):this.trigger("error",this,r,t),!1):!0}}),t.Collection=function(e,t){t||(t={}),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})},n.extend(t.Collection.prototype,t.Events,{model:t.Model,initialize:function(){},toJSON:function(){return this.map(function(e){return e.toJSON()})},add:function(e,t){var r,i,s,u,a,f,l={},c={};t||(t={}),e=n.isArray(e)?e.slice():[e];for(r=0,s=e.length;r<s;r++){if(!(u=e[r]=this._prepareModel(e[r],t)))throw new Error("Can't add an invalid model to a collection");if(l[a=u.cid]||this._byCid[a]||(f=u.id)!=null&&(c[f]||this._byId[f]))throw new Error("Can't add the same model to a collection twice");l[a]=c[f]=u}for(r=0;r<s;r++)(u=e[r]).on("all",this._onModelEvent,this),this._byCid[u.cid]=u,u.id!=null&&(this._byId[u.id]=u);this.length+=s,i=t.at!=null?t.at:this.models.length,o.apply(this.models,[i,0].concat(e)),this.comparator&&this.sort({silent:!0});if(t.silent)return this;for(r=0,s=this.models.length;r<s;r++){if(!l[(u=this.models[r]).cid])continue;t.index=r,u.trigger("add",u,this,t)}return this},remove:function(e,t){var r,i,s,o;t||(t={}),e=n.isArray(e)?e.slice():[e];for(r=0,i=e.length;r<i;r++){o=this.getByCid(e[r])||this.get(e[r]);if(!o)continue;delete this._byId[o.id],delete this._byCid[o.cid],s=this.indexOf(o),this.models.splice(s,1),this.length--,t.silent||(t.index=s,o.trigger("remove",o,this,t)),this._removeReference(o)}return this},get:function(e){return e==null?null:this._byId[e.id!=null?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},sort:function(e){e||(e={});if(!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=n.bind(this.comparator,this);return this.comparator.length==1?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return n.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var n=0,r=this.models.length;n<r;n++)this._removeReference(this.models[n]);return this._reset(),this.add(e,{silent:!0,parse:t.parse}),t.silent||this.trigger("reset",this,t),this},fetch:function(e){e=e?n.clone(e):{},e.parse===undefined&&(e.parse=!0);var r=this,i=e.success;return e.success=function(t,n,s){r[e.add?"add":"reset"](r.parse(t,s),e),i&&i(r,t)},e.error=t.wrapError(e.error,r,e),(this.sync||t.sync).call(this,"read",this,e)},create:function(e,t){var r=this;t=t?n.clone(t):{},e=this._prepareModel(e,t);if(!e)return!1;t.wait||r.add(e,t);var i=t.success;return t.success=function(n,s,o){t.wait&&r.add(n,t),i?i(n,s):n.trigger("sync",e,s,t)},e.save(null,t),e},parse:function(e,t){return e},chain:function(){return n(this.models).chain()},_reset:function(e){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,n){if(e instanceof t.Model)e.collection||(e.collection=this);else{var r=e;n.collection=this,e=new this.model(r,n),e._validate(e.attributes,n)||(e=!1)}return e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,n,r){if((e=="add"||e=="remove")&&n!=this)return;e=="destroy"&&this.remove(t,r),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments)}});var u=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];n.each(u,function(e){t.Collection.prototype[e]=function(){return n[e].apply(n,[this.models].concat(n.toArray(arguments)))}}),t.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)};var a=/:\w+/g,f=/\*\w+/g,l=/[-[\]{}()+?.,\\^$|#\s]/g;n.extend(t.Router.prototype,t.Events,{initialize:function(){},route:function(e,r,i){return t.history||(t.history=new t.History),n.isRegExp(e)||(e=this._routeToRegExp(e)),i||(i=this[r]),t.history.route(e,n.bind(function(n){var s=this._extractParameters(e,n);i&&i.apply(this,s),this.trigger.apply(this,["route:"+r].concat(s)),t.history.trigger("route",this,r,s)},this)),this},navigate:function(e,n){t.history.navigate(e,n)},_bindRoutes:function(){if(!this.routes)return;var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var n=0,r=e.length;n<r;n++)this.route(e[n][0],e[n][1],this[e[n][1]])},_routeToRegExp:function(e){return e=e.replace(l,"\\$&").replace(a,"([^/]+)").replace(f,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}}),t.History=function(){this.handlers=[],n.bindAll(this,"checkUrl")};var c=/^[#\/]/,h=/msie [\w.]+/,p=!1;n.extend(t.History.prototype,t.Events,{interval:50,getFragment:function(e,t){if(e==null)if(this._hasPushState||t){e=window.location.pathname;var n=window.location.search;n&&(e+=n)}else e=window.location.hash;return e=decodeURIComponent(e),e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(c,"")},start:function(e){if(p)throw new Error("Backbone.history has already been started");this.options=n.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),i=document.documentMode,s=h.exec(navigator.userAgent.toLowerCase())&&(!i||i<=7);s&&(this.iframe=r('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?r(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!s?r(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t,p=!0;var o=window.location,u=o.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!u)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&u&&o.hash&&(this.fragment=o.hash.replace(c,""),window.history.replaceState({},document.title,o.protocol+"//"+o.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){r(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),p=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(e){var t=this.getFragment();t==this.fragment&&this.iframe&&(t=this.getFragment(this.iframe.location.hash));if(t==this.fragment||t==decodeURIComponent(this.fragment))return!1;this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(window.location.hash)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),r=n.any(this.handlers,function(e){if(e.route.test(t))return e.callback(t),!0});return r},navigate:function(e,t){if(!p)return!1;if(!t||t===!0)t={trigger:t};var n=(e||"").replace(c,"");if(this.fragment==n||this.fragment==decodeURIComponent(n))return;this._hasPushState?(n.indexOf(this.options.root)!=0&&(n=this.options.root+n),this.fragment=n,window.history[t.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,t.replace),this.iframe&&n!=this.getFragment(this.iframe.location.hash)&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e)},_updateHash:function(e,t,n){n?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}}),t.View=function(e){this.cid=n.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()};var d=/^(\S+)\s*(.*)$/,v=["model","collection","el","id","attributes","className","tagName"];n.extend(t.View.prototype,t.Events,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,n){var i=document.createElement(e);return t&&r(i).attr(t),n&&r(i).html(n),i},setElement:function(e,t){return this.$el=r(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=w(this,"events")))return;this.undelegateEvents();for(var t in e){var r=e[t];n.isFunction(r)||(r=this[e[t]]);if(!r)throw new Error('Event "'+e[t]+'" does not exist');var i=t.match(d),s=i[1],o=i[2];r=n.bind(r,this),s+=".delegateEvents"+this.cid,o===""?this.$el.bind(s,r):this.$el.delegate(o,s,r)}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=n.extend({},this.options,e));for(var t=0,r=v.length;t<r;t++){var i=v[t];e[i]&&(this[i]=e[i])}this.options=e},_ensureElement:function(){if(!this.el){var e=w(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}else this.setElement(this.el,!1)}});var m=function(e,t){var n=b(this,e,t);return n.extend=this.extend,n};t.Model.extend=t.Collection.extend=t.Router.extend=t.View.extend=m;var g={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};t.sync=function(e,i,s){var o=g[e],u={type:o,dataType:"json"};return s.url||(u.url=w(i,"url")||E()),!s.data&&i&&(e=="create"||e=="update")&&(u.contentType="application/json",u.data=JSON.stringify(i.toJSON())),t.emulateJSON&&(u.contentType="application/x-www-form-urlencoded",u.data=u.data?{model:u.data}:{}),t.emulateHTTP&&(o==="PUT"||o==="DELETE")&&(t.emulateJSON&&(u.data._method=o),u.type="POST",u.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",o)}),u.type!=="GET"&&!t.emulateJSON&&(u.processData=!1),r.ajax(n.extend(u,s))},t.wrapError=function(e,t,n){return function(r,i){i=r===t?i:r,e?e(t,i,n):t.trigger("error",t,i,n)}};var y=function(){},b=function(e,t,r){var i;return t&&t.hasOwnProperty("constructor")?i=t.constructor:i=function(){e.apply(this,arguments)},n.extend(i,e),y.prototype=e.prototype,i.prototype=new y,t&&n.extend(i.prototype,t),r&&n.extend(i,r),i.prototype.constructor=i,i.__super__=e.prototype,i},w=function(e,t){return!e||!e[t]?null:n.isFunction(e[t])?e[t]():e[t]},E=function(){throw new Error('A "url" property or function must be specified')};return t});