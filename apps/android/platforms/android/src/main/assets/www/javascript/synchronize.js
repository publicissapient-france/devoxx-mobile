define(["log","db","ui"],function(a,b,c){var d=a.getLogger("synchronize");d.info("Loading synchronize.js"),d.info("Defining synchronize object");var e={urls:[]};d.info("Loaded synchronize");var f=!1;return e.addUrl=function(a,b){e.urls.push({cacheKey:a,url:b})},e.beforePageShow=function(a){c.resetFlashMessages("#synchronize"),e.registerBindings(a)},e.registerBindings=function(a){$("#synchronize-home-submit").bind("click",function(b){a&&a(),e.onSubmit(b)}),$("#synchronize-running-submit").bind("click",e.onCancel)},e.onSubmit=function(a){try{e.startSynchronization()}catch(a){console.info("Error catched: "+a)}return a.preventDefault(),!1},e.onCancel=function(a){try{e.askCancel()}catch(a){console.info("Error catched: "+a)}return a.preventDefault(),!1},e.askCancel=function(a){f=!0},e.startSynchronization=function(){e.shouldCancel=!1,$("#synchronize-home").hide(),$("#synchronize-running").show();var a=$.extend([],e.urls);e.synchronize(a)},e.synchronize=function(a){if(_(a).isEmpty()||f){e.onSuccess({});return}var c=_(a).head();$.ajax({url:c.url,dataType:"jsonp",cache:!1}).success(function(f,g,h){d.info("Fetch succeded for url: "+c.url),b.save(c.cacheKey,f);var i=_(a).tail();e.synchronize(i)}).error(function(a,b,f){d.info("Fetch failed for url: "+c.url),e.onError({error:{textStatus:b,errorThrown:f}})})},e.onSuccess=function(a){e.finalizeSynchronization(a),c.resetFlashMessages("#synchronize"),d.info("Synchronization ended with success")},e.onError=function(a){d.info("Synchronization ended with error"),e.finalizeSynchronization(a),c.showFlashMessage({page:"#synchronize",type:"error",message:"Erreur lors de la synchronisation !"})},e.finalizeSynchronization=function(a){d.info("Finalizing synchronization ..."),$("#synchronize-running").hide(),$("#synchronize-home").show(),$.mobile.silentScroll(0)},e})