define(["log","utils","collection","entry","ui","db","synchronize"],function(a,b,c,d,e,f,g){function h(a,b,c,d,e,f,g){var h=n.getParams(b[1]);m.getPageContextValue(d.id,"id")!==h.id?(m.setPageContextValue(d.id,"initialized",!0),m.setPageContextValue(d.id,"id",h.id),f(h.id)):g&&g(a,b,c,d,e)}function i(a,b,c,d,e,f,g){var h=n.getParams(b[1]);m.getPageContextValue(d.id,"initialized")?g&&g(a,b,c,d,e):(m.setPageContextValue(d.id,"initialized",!0),f(h))}function j(a,b,c,d,e,f){var g=n.getParams(b[1]);f(g)}var k=a.getLogger("core");k.info("Loading core.js");var l="11",m={},n,o={events:[{id:"11",name:"Devoxx France 2014",days:[{id:"1",name:"Mercredi 16 Avril",date:"2014-04-16"},{id:"2",name:"Jeudi 17 Avril",date:"2014-04-17"},{id:"3",name:"Vendredi 18 Avril",date:"2014-04-18"}]}]};m.getEvent=function(a){return _(o.events).find(function(b){return b.id==a})},m.getDay=function(a,b){return _(a.days).find(function(a){return a.id==b})};var p={};return m.createPageContext=function(a){p[a]={initialized:!1}},m.initializePageContextIfNecessary=function(a){p[a]||m.createPageContext(a)},m.getPageContextValue=function(a,b){return m.initializePageContextIfNecessary(a),p[a][b]},m.getPageContexts=function(){return p},m.setPageContextValue=function(a,b,c){m.initializePageContextIfNecessary(a),p[a][b]=c},m.clearPageContexts=function(){_(m.getPageContexts()).each(function(a){a.id&&(a.id=undefined),a.initialized&&(a.initialized=!1)})},m.addUrlsForEvent=function(a){g.addUrl(a+"/schedule",b.getFullUrl("/"+a+"/schedule?callback=?")),g.addUrl(a+"/presentations",b.getFullUrl("/"+a+"/presentations?callback=?")),g.addUrl(a+"/rooms",b.getFullUrl("/"+a+"/rooms?callback=?")),g.addUrl(a+"/tracks",b.getFullUrl("/"+a+"/tracks?callback=?")),g.addUrl(a+"/speakers",b.getFullUrl("/"+a+"/speakers?callback=?"))},m.setupRouter=function(){k.info("Instanciating jqmr router"),n=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))":{handler:"onBeforeDayPageShow",events:"bs"},"#event(?:[?](.*))":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomsPageShow",events:"bs"},"#room(?:[?](.*))":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#track(?:[?](.*))":{handler:"onBeforeTrackPageShow",events:"bs"},"#synchronize":{handler:"onBeforeSynchronizePageShow",events:"bs"}},{onBeforeSchedulePageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.refreshSchedule,m.renderCollectionView)},onBeforeDayPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshDay,m.renderCollectionView)},onBeforeEventPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshEvent)},onBeforeRoomsPageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.refreshRooms)},onBeforeRoomPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshRoom,m.renderCollectionView)},onBeforeTracksPageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.refreshTracks)},onBeforeTrackPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshTrack,m.renderCollectionView)},onBeforePresentationsPageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.refreshPresentations,m.renderCollectionView)},onBeforePresentationPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshPresentation,m.renderEntryView)},onBeforeSpeakersPageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.refreshSpeakers)},onBeforeSpeakerPageShow:function(a,b,c,d,e){h(a,b,c,d,e,m.refreshSpeaker)},onBeforeSynchronizePageShow:function(a,b,c,d,e){i(a,b,c,d,e,m.onSynchronizeBeforePageShow)}}),k.info("Instanciated jqmr router")},m.refreshDataList=function(a){k.info("Loading "+a.title+" View"),c.views[a.view]=new c.EntryListView({dataType:a.dataType,fetchUrl:a.url,el:a.el,collectionTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&f.save(a.cacheKey,b),a.parse&&(b=a.parse(b)),b},view:a.view,postRender:a.postRender}),c.views[a.view].collection.length!==0&&c.views[a.view].collection.reset([]),k.info("Fetch "+a.title+" Data from url: '"+c.views[a.view].collection.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),e.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),m.onFetchSuccess(b,c,a)},error:function(b,c,d){m.onFetchError(b,c,d,a)},fetchUrl:a.url};f.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),c.views[a.view].collection.reset(b),e.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),c.views[a.view].el.empty(),c.views[a.view].collection.fetch(b)})},m.refreshDataEntry=function(a){k.info("Loading "+a.title+" View"),d.views[a.view]=new d.EntryView({dataType:a.dataType,fetchUrl:a.url,el:a.el,entryTemplate:a.template,parse:function(b){return a.cacheKey&&!b.statusCode&&f.save(a.cacheKey,b),a.parse&&(b=a.parse(b)),b},postRender:a.postRender,view:a.view}),d.views[a.view].entry&&d.views[a.view].entry.clear(),k.info("Fetch "+a.title+" Data from url: '"+d.views[a.view].entry.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),k.info("Show "+a.title+" page message!"),e.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),m.onFetchSuccess(b,c,a)},error:function(b,c,d){m.onFetchError(b,c,d,a)},fetchUrl:a.url};f.getOrFetch(a.cacheKey,function(b){a.parse&&(b=a.parse(b)),d.views[a.view].entry.set(b),e.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),d.views[a.view].entry.fetch(b)})},m.refreshSchedule=function(){e.resetFlashMessages("#schedule"),e.switchTitle("schedule","Planning"),m.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/"+l+"/schedule?callback=?"),cacheKey:"/"+l+"/schedule",dataType:"session",parse:function(a){return _(a).each(m.enhanceSession),a}})},m.refreshDay=function(a){e.resetFlashMessages("#day"),k.info("Processing day: "+a);var c=m.getEventDay(a),d=c?c.name:"Jour "+a;e.switchTitle("day",d),m.refreshDataList({page:"#day",title:d,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/"+l+"/schedule?callback=?"),cacheKey:"/"+l+"/schedule",dataType:"session",parse:function(a){return a=m.filterSessionsByDay(a,c),_(a).each(m.enhanceSession),a}})},m.refreshPresentations=function(){e.resetFlashMessages("#presentations"),k.info("Refreshing presentations"),e.switchTitle("presentations","Présentations"),m.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentations",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+l+"/presentations?callback=?"),cacheKey:"/"+l+"/presentations",dataType:"presentation",parse:function(a){return _(a).each(m.enhancePresentationListItem),a}})},m.refreshPresentation=function(a){e.resetFlashMessages("#presentation"),k.info("Processing presentation: "+a),e.switchTitle("presentation","Présentation"),m.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:b.getFullUrl("/"+l+"/presentations?callback=?"),cacheKey:"/"+l+"/presentations",dataType:"presentation",parse:function(b){var c=m.findPresentationById(b,a);return m.enhancePresentation(c),c},postRender:function(a){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),e.switchTitle("presentation",a.get("title"))}})},m.refreshSpeakers=function(){e.resetFlashMessages("#speakers"),k.info("Refreshing speakers"),e.switchTitle("speakers","Speakers"),m.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speakers",template:$("#speaker-list-tpl").html(),url:b.getFullUrl("/"+l+"/speakers?callback=?"),cacheKey:"/"+l+"/speakers",dataType:"speaker",parse:function(a){return a}})},m.refreshSpeaker=function(a){e.resetFlashMessages("#speaker"),k.info("Processing speaker: "+a),e.switchTitle("speaker","Speaker"),m.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:b.getFullUrl("/"+l+"/speakers?callback=?"),cacheKey:"/"+l+"/speakers",dataType:"speaker",parse:function(b){var c=m.findSpeakerById(b,a);return m.enhanceSpeaker(c),c},postRender:function(a){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var b=a.get("firstName")?a.get("firstName"):"";b+=a.get("firstName")&&a.get("lastName")?" ":"",b+=a.get("lastName")?a.get("lastName"):"",b&&e.switchTitle("speaker",b)}})},m.refreshTracks=function(){e.resetFlashMessages("#tracks"),k.info("Refreshing tracks"),e.switchTitle("tracks","Tracks"),m.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"tracks",template:$("#track-list-tpl").html(),url:b.getFullUrl("/"+l+"/tracks?callback=?"),cacheKey:"/"+l+"/tracks",dataType:"track",parse:function(a){return a}})},m.refreshTrack=function(a){e.resetFlashMessages("#track"),k.info("Refreshing track"),e.switchTitle("track","Track"),m.refreshDataList({page:"#track",title:"Track",el:"#track-presentation-list",view:"track",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+l+"/presentations?callback=?"),cacheKey:"/"+l+"/presentations",dataType:"presentation",parse:function(b){return b=m.filterPresentationsByTrackKey(b,a),_(b).each(m.enhancePresentationListItem),b},postRender:function(a){a.length>0&&e.switchTitle("track",a[0].get("track"))}})},m.refreshRooms=function(){e.resetFlashMessages("#rooms"),k.info("Refreshing rooms"),e.switchTitle("rooms","Salles"),m.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"rooms",template:$("#room-list-tpl").html(),url:b.getFullUrl("/"+l+"/rooms?callback=?"),cacheKey:"/"+l+"/rooms",dataType:"room",parse:function(a){return a}})},m.refreshRoom=function(a){e.resetFlashMessages("#room"),k.info("Refreshing room"),e.switchTitle("room","Room"),m.refreshDataList({page:"#room",title:"Room",el:"#room-presentation-list",view:"room",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/"+l+"/presentations?callback=?"),cacheKey:"/"+l+"/presentations",dataType:"presentation",parse:function(b){return b=m.filterPresentationsByRoomKey(b,a),_(b).each(m.enhancePresentationListItem),b},postRender:function(a){a.length>0&&e.switchTitle("room",a[0].get("room"))}})},m.renderEntryView=function(a,b,c,e,f){d.views[e.id].render()},m.renderCollectionView=function(a,b,d,e,f){c.views[e.id].render()},m.onFetchSuccess=function(a,b,c){a.get("statusCode")=="404"&&e.showFlashMessage(_.extend({type:"error",message:a.get("message")},c)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),e.hideFlashMessage(c)},0)},m.onFetchError=function(a,b,c,d){setTimeout(function(){k.info("Error response tmp: '"+b+"' for url: '"+d.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),e.hideFlashMessage(d),e.showFlashMessage(_.extend({type:"error",message:"No data found ..."},d))},0)},m.getParams=function(a){if(!a)return null;var b={},c,d=a.slice(a.indexOf("?")+1).split("&");return $.each(d,function(a,d){c=d.split("="),b[c[0]]?(b[c[0]]instanceof Array||(b[c[0]]=[b[c[0]]]),b[c[0]].push(c[1])):b[c[0]]=c[1]}),$.isEmptyObject(b)?null:b},m.getEventDay=function(a){var b=m.getEvent(l);return m.getDay(b,a)},m.enhanceSession=function(a){a.presentationUri&&(a.presentationId=m.getPresentationIdFromUri(a.presentationUri)),a.startTime=m.getScheduleTime(a.fromTime),a.endTime=m.getScheduleTime(a.toTime)},m.filterSessionsByDay=function(a,b){return _(a).filter(function(a){return b&&a.fromTime.substr(0,10)===b.date})},m.findEventById=function(a,b){return _(a).find(function(a){return a.id==b})},m.getPresentationIdFromUri=function(a){return Number(a.substring(a.lastIndexOf("/")+1))},m.getScheduleTime=function(a){return Date.parseExact(a,"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},m.enhancePresentationListItem=function(a){m.updateLanguage(a)},m.getSpeakerIdFromUri=function(a){return a.substring(a.lastIndexOf("/")+1)},m.enhancePresentation=function(a){m.updateLanguage(a),a.enhanced||(a.summary=m.formatPresentationSummary(a),a.enhanced=!0),_(a.speakers).each(function(a){a.id=a.id})},m.findPresentationById=function(a,b){return _(a).find(function(a){return a.id==b})},m.findSpeakerById=function(a,b){return _(a).find(function(a){return a.id==b})},m.enhanceSpeaker=function(a){a.enhanced||(a.bio=b.linkify(a.bio),a.enhanced=!0),_(a.talks).each(function(a){a.id=m.getPresentationIdFromUri(a.presentationUri)})},m.filterPresentationsByTrackKey=function(a,b){return b=b.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(a).filter(function(a){var c=a.track.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return c==b})},m.filterPresentationsByRoomKey=function(a,b){return b=b.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase(),_(a).filter(function(a){var c=a.room.replace(/[ ]/g,"_").replace(/[&<>,]/g,"").replace(/[éè]/g,"e").toUpperCase();return c==b})},m.updateLanguage=function(a){a.language&&(a.language=a.language.toUpperCase())},m.onSynchronizeBeforePageShow=function(){g.beforePageShow(m.clearPageContexts)},m.formatPresentationSummary=function(a){return b.linkify(a.summary.replace(/\n/g,"<br />"))},m.getDetailView=function(a){return d.views[a]},k.info("Loaded core"),m.addUrlsForEvent(l),m})