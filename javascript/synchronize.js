define(["log","db","ui"],function(e,t,n){var r=e.getLogger("synchronize");r.info("Loading synchronize.js"),r.info("Defining synchronize object");var i={urls:[]};r.info("Loaded synchronize");var s=!1;return i.addUrl=function(e,t){i.urls.push({cacheKey:e,url:t})},i.beforePageShow=function(e){n.resetFlashMessages("#synchronize"),i.registerBindings(e)},i.registerBindings=function(e){$("#synchronize-home-submit").bind("click",function(t){e&&e(),i.onSubmit(t)}),$("#synchronize-running-submit").bind("click",i.onCancel)},i.onSubmit=function(e){try{i.startSynchronization()}catch(e){console.info("Error catched: "+e)}return e.preventDefault(),!1},i.onCancel=function(e){try{i.askCancel()}catch(e){console.info("Error catched: "+e)}return e.preventDefault(),!1},i.askCancel=function(e){s=!0},i.startSynchronization=function(){i.shouldCancel=!1,$("#synchronize-home").hide(),$("#synchronize-running").show();var e=$.extend([],i.urls);i.synchronize(e)},i.synchronize=function(e){if(_(e).isEmpty()||s){i.onSuccess({});return}var n=_(e).head();$.ajax({url:n.url,dataType:"jsonp",cache:!1}).success(function(s,o,u){r.info("Fetch succeded for url: "+n.url),t.save(n.cacheKey,s);var a=_(e).tail();i.synchronize(a)}).error(function(e,t,s){r.info("Fetch failed for url: "+n.url),i.onError({error:{textStatus:t,errorThrown:s}})})},i.onSuccess=function(e){i.finalizeSynchronization(e),n.resetFlashMessages("#synchronize"),r.info("Synchronization ended with success")},i.onError=function(e){r.info("Synchronization ended with error"),i.finalizeSynchronization(e),n.showFlashMessage({page:"#synchronize",type:"error",message:"Erreur lors de la synchronisation !"})},i.finalizeSynchronization=function(e){r.info("Finalizing synchronization ..."),$("#synchronize-running").hide(),$("#synchronize-home").show(),$.mobile.silentScroll(0)},i});